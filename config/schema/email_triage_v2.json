{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "EmailTriageV2",
  "description": "Strict JSON Schema for email triage structured output (LLM Inference Layer)",
  "type": "object",
  "additionalProperties": false,
  "required": ["dictionaryversion", "sentiment", "priority", "topics"],
  "properties": {
    "dictionaryversion": {
      "type": "integer",
      "minimum": 1,
      "description": "Dictionary version identifier (must match input)"
    },
    "sentiment": {
      "type": "object",
      "additionalProperties": false,
      "required": ["value", "confidence"],
      "properties": {
        "value": {
          "type": "string",
          "enum": ["positive", "neutral", "negative"],
          "description": "Sentiment label"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Classification confidence (0-1)"
        }
      }
    },
    "priority": {
      "type": "object",
      "additionalProperties": false,
      "required": ["value", "confidence", "signals"],
      "properties": {
        "value": {
          "type": "string",
          "enum": ["low", "medium", "high", "urgent"],
          "description": "Priority label"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Classification confidence (0-1)"
        },
        "signals": {
          "type": "array",
          "maxItems": 6,
          "items": {
            "type": "string"
          },
          "description": "Short phrases explaining priority rationale"
        }
      }
    },
    "topics": {
      "type": "array",
      "minItems": 1,
      "maxItems": 5,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["labelid", "confidence", "keywordsintext", "evidence"],
        "properties": {
          "labelid": {
            "type": "string",
            "enum": [
              "FATTURAZIONE",
              "ASSISTENZATECNICA",
              "RECLAMO",
              "INFOCOMMERCIALI",
              "DOCUMENTI",
              "APPUNTAMENTO",
              "CONTRATTO",
              "GARANZIA",
              "SPEDIZIONE",
              "UNKNOWNTOPIC"
            ],
            "description": "Topic label from closed taxonomy"
          },
          "confidence": {
            "type": "number",
            "minimum": 0,
            "maximum": 1,
            "description": "Topic classification confidence (0-1)"
          },
          "keywordsintext": {
            "type": "array",
            "minItems": 1,
            "maxItems": 15,
            "items": {
              "type": "object",
              "additionalProperties": false,
              "required": ["candidateid", "lemma", "count"],
              "properties": {
                "candidateid": {
                  "type": "string",
                  "description": "Candidate ID from input list (MUST NOT be invented)"
                },
                "lemma": {
                  "type": "string",
                  "description": "Lemmatized form of keyword"
                },
                "count": {
                  "type": "integer",
                  "minimum": 1,
                  "description": "Frequency in email"
                },
                "spans": {
                  "type": "array",
                  "items": {
                    "type": "array",
                    "minItems": 2,
                    "maxItems": 2,
                    "items": {
                      "type": "integer",
                      "minimum": 0
                    }
                  },
                  "description": "Optional: positions in text where keyword appears [[start, end], ...]"
                }
              }
            },
            "description": "Keywords selected from candidates (1-15 per topic)"
          },
          "evidence": {
            "type": "array",
            "minItems": 1,
            "maxItems": 2,
            "items": {
              "type": "object",
              "additionalProperties": false,
              "required": ["quote"],
              "properties": {
                "quote": {
                  "type": "string",
                  "maxLength": 200,
                  "description": "Short text excerpt supporting the topic (â‰¤200 chars)"
                },
                "span": {
                  "type": "array",
                  "minItems": 2,
                  "maxItems": 2,
                  "items": {
                    "type": "integer",
                    "minimum": 0
                  },
                  "description": "Optional: [start, end] position in body_text_canonical"
                }
              }
            },
            "description": "Supporting quotes from email (1-2 per topic)"
          }
        }
      },
      "description": "Multi-label topic classification (1-5 topics)"
    }
  }
}
